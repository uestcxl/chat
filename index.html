<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>淮安娱乐 － 聊天室</title>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
    <script type="text/javascript">
        $(function() {
            var name = 'ireoo' + Math.floor(Math.random()*1000000+1);
            var avatar = 'http://www.ireoo.com/u/s1.jpg';
            var myip = 'www.ireoo.com';

            /**
             * 连接服务器
             */
            var socket = io.connect(null);
            var spantimer = [];


            socket.on('chatall', function(msg) {

                chatcom(msg.id, msg.avatar, msg.msg, msg.timer);

            });
            socket.on('change', function(socketid) {

                $('ul.chatroom li#' + socketid).remove();

            });
            socket.on('loginIn', function(user) {

                addplayer(user.id, user.name, user.avatar);

            });
            socket.on('getplayers', function(users) {

                for(var i = 0; i < users.length; i++) {
                    addplayer(users[i].id, users[i].name, users[i].avatar);
                }

            });

            /**
             * 登录服务器命令
             */
            socket.emit('login', {
                name : name,
                avatar : avatar
            });


            /**
             *
             * 创建聊天框
             *
             */

            var chatbox = $('<div />').css({borderRadius: '5px', boxShadow: '0 0 5px #333', position: 'fixed', bottom: '20px', left: '20px', overflow: 'hidden'}).width($(window).width() - 40).height(50).appendTo('body');
            var chatinput = $('<input />').css({border: 'none', padding: '10px', fontSize: '20px', outline: 'none'}).width(chatbox.width() - 20).height(chatbox.height() - 20).appendTo(chatbox).focus(function() {
                chatbox.css({boxShadow: '0 0 5px #4898F8'});
            }).blur(function() {
                chatbox.css({boxShadow: '0 0 5px #333'});
            });
            chatinput.keypress(function(e) {
                        //alert(chatinput.val());
                        if(e.keyCode == 13) {

                            if(chatinput.val() != '') {
                                socket.emit('chatall', {
                                    id    : name,
                                    msg   : chatinput.val(),
                                    ip    : myip,
                                    timer : 0
                                });
                                chatinput.val('');
                            }
                            return false;
                        }
                    });

            /**
             *
             * 创建列表框
             * @type {appendTo|*|jQuery}
             */

            var listbox = $('<ul />').css({borderRadius: '5px', boxShadow: '0 0 5px #333', position: 'fixed', top: '0', right: '20px', overflow: 'hidden', padding: '0'}).width(200).height($(window).height() - 110).addClass('chatroom').appendTo('body');

            var css = {listStyle: 'none', padding:'5px', margin: '5px'};

            var addplayer = function(socketid, player, avatar) {
                var one = $('<li />').css(css).attr('id', socketid).hover(
                        function() {
                            $(this).addClass('hover');
                        },
                        function() {
                            $(this).removeClass('hover');
                        }
                ).click(
                        function(e) {
//                            var cunzai = false;
//                            $('ul.chatroom li').each(
//                                    function(e) {
//                                        if($(this).attr('id') == socketid) cunzai = true;
//                                    }
//                            );
//                            if(!cunzai) {
//                                addchat(socketid, player, avatar);
//                            }
                        }
                );
                var img = $('<img />').attr('src', avatar).css({float: 'left'}).width(40).height(40);
                var name = $('<h2 />').text(player).css({margin: '0', padding: '0 0 0 50px', fontSize: '16px', fontWeight: 'bold'}).height(40);
//                message.append(input).append(to).append(by);
                one.append(img).append(name).appendTo(listbox); //.append(message);

            };

            /**
             *
             * 创建聊天框
             *
             */

            var chatroom = $('<ul />').css({padding: '0', margin: '0', listStyle: 'none', position: 'fixed', top: '20px', left: '20px', overflow: 'auto'}).width($(window).width() - 260).height($(window).height() - 110).appendTo('body');

            var chatheight = 0;

            var chatcom = function(name, avatar, msg, timer) {
                var image = $('<img />').attr('src', avatar).width(50).height(50).css({borderRadius: '5px', verticalAlign: 'bottom'});
                var com = $('<div />').css({background: '#EBEBEB', borderRadius: '5px', padding: '5px', verticalAlign: 'bottom', display: 'inline-block', marginLeft: '10px', wordBreak: 'break-all', wordWrap: 'break-word', maxWidth: (chatroom.width() - 400) + 'px'}).text(msg);
                var li = $('<li />').css({marginBottom: '10px'}).append(image).append(com).appendTo(chatroom);
                chatheight += li.height() + 10;
                chatroom.animate({scrollTop: chatheight}, 300);
            };
        });
    </script>
</head>
<body>

</body>
</html>